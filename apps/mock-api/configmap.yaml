apiVersion: v1
kind: ConfigMap
metadata:
  name: mock-api-app
  namespace: demo
data:
  app.py: |
    #!/usr/bin/env python3
    from flask import Flask, request, jsonify, render_template_string
    from flask_cors import CORS
    from datetime import datetime
    import json
    import logging

    app = Flask(__name__)
    CORS(app)  # Enable CORS for all routes

    # Configure logging
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    logger = logging.getLogger(__name__)

    # In-memory storage for demo purposes
    notifications = []

    HTML_TEMPLATE = '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>Mock API - Notifications</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background: #f7fafc;
            }
            h1 {
                color: #2d3748;
            }
            .notification {
                background: white;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 15px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .notification-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
                padding-bottom: 10px;
                border-bottom: 1px solid #e2e8f0;
            }
            .timestamp {
                color: #718096;
                font-size: 0.9em;
            }
            .status {
                background: #48bb78;
                color: white;
                padding: 4px 12px;
                border-radius: 4px;
                font-size: 0.85em;
                font-weight: 600;
            }
            pre {
                background: #f7fafc;
                padding: 15px;
                border-radius: 4px;
                overflow-x: auto;
            }
            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #718096;
            }
            .btn {
                background: #667eea;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1em;
            }
            .btn:hover {
                background: #5a67d8;
            }
            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
            }
            .stats {
                background: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
        </style>
        <script>
            function clearNotifications() {
                if (confirm('Clear all notifications?')) {
                    fetch('/notifications/clear', {method: 'POST'})
                        .then(() => location.reload());
                }
            }
            // Auto-refresh every 5 seconds
            setTimeout(() => location.reload(), 5000);
        </script>
    </head>
    <body>
        <div class="header">
            <h1>ðŸ“¨ File Processing Notifications</h1>
            <div class="stats">
                <strong>Total:</strong> {{ total }} notifications
            </div>
        </div>
        <button class="btn" onclick="clearNotifications()">Clear All</button>

        {% if notifications %}
            {% for notif in notifications %}
            <div class="notification">
                <div class="notification-header">
                    <span class="timestamp">{{ notif.received_at }}</span>
                    <span class="status">Received</span>
                </div>
                <pre>{{ notif.data | tojson(indent=2) }}</pre>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <h2>No notifications yet</h2>
                <p>Upload a file to see processing notifications here</p>
            </div>
        {% endif %}
    </body>
    </html>
    '''

    @app.route('/health', methods=['GET'])
    def health():
        return jsonify({"status": "healthy"}), 200

    @app.route('/webhook', methods=['POST'])
    def webhook():
        try:
            data = request.get_json()

            # Log received data
            logger.info(f"Received webhook: {json.dumps(data, indent=2)}")

            # Store notification
            notification = {
                "received_at": datetime.utcnow().isoformat(),
                "data": data,
                "headers": dict(request.headers)
            }
            notifications.append(notification)

            # Keep only last 100 notifications
            if len(notifications) > 100:
                notifications.pop(0)

            return jsonify({
                "status": "accepted",
                "notification_id": len(notifications)
            }), 200

        except Exception as e:
            logger.error(f"Error processing webhook: {str(e)}")
            return jsonify({"error": str(e)}), 500

    @app.route('/notifications', methods=['GET'])
    def get_notifications():
        # Check if HTML is requested
        accept = request.headers.get('Accept', '')
        if 'text/html' in accept or request.args.get('format') == 'html':
            return render_template_string(
                HTML_TEMPLATE,
                notifications=list(reversed(notifications[-20:])),
                total=len(notifications)
            )

        # Return JSON
        limit = request.args.get('limit', 10, type=int)
        return jsonify({
            "total": len(notifications),
            "notifications": notifications[-limit:]
        }), 200

    @app.route('/notifications/clear', methods=['POST'])
    def clear_notifications():
        notifications.clear()
        logger.info("All notifications cleared")
        return jsonify({"status": "cleared"}), 200

    @app.route('/', methods=['GET'])
    def index():
        return render_template_string(
            HTML_TEMPLATE,
            notifications=list(reversed(notifications[-20:])),
            total=len(notifications)
        )

    if __name__ == '__main__':
        app.run(host='0.0.0.0', port=8080, debug=False)

  requirements.txt: |
    flask==3.0.0
    flask-cors==4.0.0
    werkzeug==3.0.1
